---
title: Forensic 
author: Yuchao
date: 2023-01-29 11:33:00 +0800
categories: [sec]
tags: [forensic]
math: true
mermaid: true
---

# SANS 3MinMax

Kevin Ripa

## 5 Windows Quick Win Artifacts

#### Registry 
- aka. hives: SAM,System,Software,Secrutiy,NTUser
- find what: MRU Lists, System searches, Browser typed URLs, USB/Wifi connection, SSIDs, Network connections, Programs/services running at startup, etc.
- Registry Explorer.(by Eric Zimmerman)
- C:\Windows\system32\config\SAM
- RecentDocs, USBSTOR, 

#### Jumplists 
- file, folder user performed historically.
- {userFile}\AppData\Roaming\Microsoft\Recent Items\AutomaticDestinations
- last folder above need to be input manually.
- "{appID}.automaticDestinations-ms" files
- jumplist explorer: "jlecmd -f {one-ms file path} "
- "jlecmd -f {one-ms file path}  --csv {output path}" output as csv.

#### ".LNK"
- {userFile}\AppData\Roaming\Microsoft\Recent Items
- files in above folder, are files interacted before.
- when date created same as date modified, mean opened once. Otherwise, more than once.
- real file has different time stamp, as file above is the shortcut`s timestamp.
- when real file deleted, link file still stays.
- ``` lecmd -f {linkFilePath} --csv {outPutPath} ``` or -d to directory.

#### Shellbags
- open a folder again, same location, same window size.
- {userFile}\AppData\Roaming\Microsoft\Windows\UsrClass.dat
- HKEY_CLASSES_ROOT\Local Settings\Software\Microsoft\Windows\Shell
- ZM tool: ShellBags Explorer
- 

#### Prefetch


--- 

# Read Practical Malware Analysis

## types
	- Backdoor, botnet, downloader, launcher, rootkit, scareware, spam, worm
	- persistence mechanism: windows registry

## static
	1. hash as a fingerprint.
	2. find strings
	3. detect packed and obfuscated malware
	4. linked library and functions
	5. PE file headers: meta data about the file

## Dynamic:
	1. source-level, assembly-level debug.
	2. kernel, user-mode debug.


## Process VS Service:
	- A process is an instance of a particular executable (.exe program file) running. 
	- A service is a process which runs in the background and does not interact with the desktop


## PE: magic number "MZ"
	1. PE Header
		metadata information, pointers, and links to address sections in memory. 
	2. PE Data Section
		.text stores the actual code of the program
		.data holds the initialized and defined variables
		.bss holds the uninitialized data (declared variables with no assigned values)
		.rdata contains the read-only data
		.edata: contains exportable objects and related table information
		.idata imported objects and related table information
		.reloc image relocation information
		.rsrc links external resources used by the program such as images, icons, embedded binaries, and manifest file, which has all information about program versions, authors, company, and copyright!

## AV Evasion:
	1. staged payload.
	2. packer. Packing and Obfuscation.
	3. Binder.
	4. Sandbox evasion. 

## Virtual memory:
	page virtual memory to the disk to slove: more virtual memory than physical memory allocated.

## Tools:
	- PEview
	- FSG packer
	- UPX packer
	- Dependency Walker
	- Resource Hacker
		To counter: resource section contains another PE executable.
		Use:save the resource as binary data, then analyze.
			click Action>Save resource as binary file.
	- downloader
		downloads additional malware
	- Regshot
		take a baseline snapshot of the registry


## Imports: (MSDN documentation)
	- type: networking, service-manipulation, registry-manipulation.

	- WS2_32.dll		-> network functionality
	- wininet.dll		-> F: InternetOpen, InternetOpenURL	-> connects to Internet
		InternetReadFile, InternetCloseHandle, InternetOpenUrlA, InternetOpenA
	- advapi32.dll	-> permissions

	- kernel32.dll	-> F: FindFirstFile, FindNextFile	 -> filesystem(modify files)
	- kernel32.dll	-> F: CreateProcess, Sleep			 -> backdoors
	- kernel32.dll	-> F: CreateFile, WriteFile, WinExec -> write to disk & execute
	- kernel32.dll	-> F: LoadResource, FindResource	 -> loads data from resource section 

	- CreateFileA, CreateFileMappingA, and MapViewOfFile -> probably opens a file and maps it into memory.
	- LoadLibrary, or GetProcAddress -> load DLL and use its function at runtime.

## Exports: mostly for DLL
	- ServiceMain 	-> malware needs to be installed as a service.
		svchost.exe: a shared-service process that serves as a shell for loading services from DLL files.
	- rundll32: can run DLL with exports.

## Use of mutex
	only one copy of the program is running at a time.

## Dynamic analysis...

#### Before run malware:
	- run procmon
	- start Process Explorer
	- set up virtual network (including ApateDNS, Netcat, Wireshark)
#### Run malware:
	- In Process Explorer: 
		Handlers: may find Mutant.
		Dlls.
	- procmon filter process actions:
		need to filter out a certain amount of noise.
		find if it: RegSetValue, WriteFile.
			write file to copy itself.
			modify register to run on system startup.
#### Check ApateDNS
		if malware performed DNS requests.
#### Check netcat
		find what the malware requested.


## IDA Pro DLL
	
	- Start from DllMain
		all code that executes from the DllEntryPoint until DllMain has likely been generated by the compiler
	- CTRL-X with the cursor on gethostbyname: check cross-references.
	- byte_ prefix: IDA believes a one byte variable.
	- off_ prefix: a pointer variable.
	- Rabit hole: IDA may fail to label function like printf, and you may lost in it.

---


# THM DFIR (Digital Forensics and Incident Response)

## Eric Zimmerman

## artifacts:
	- pieces of information that provide evidence of human activity.
	- collected from the Endpoint or Server's file system, memory, or network activity.

	#### type:
		- Strings ("exec": a backdoor)
		- API calls
		- Memory dumps
		- Filesystem modifications
		- Log events
		- Running processes
		- Web requests
		- IP address string routable to Command and control server
		- IOCs can be MD5, SHA1, SHA256 hashes, IP address, C2 domain, file size, filename, file path, a registry key, etc.

	#### Windows Registry
		- if only access to disk image.
			C:\Windows\System32\Config
			NTUSER.DAT, USRCLASS.DAT
			C:\Windows\AppCompat\Programs\Amcache.hve
				save information on programs that were recently run on the system
		- transaction logs
			journal of the changelog of the registry hive.
		- Registry backups
		- tools: Registry Viewer, similar to Windows Registry Editor, but on disk image.
		- Forensic use:
			Find OS version: SOFTWARE\Microsoft\Windows NT\CurrentVersion
			Computer Name, Time Zone Information, Autostart Programs.
			Network Interfaces: IP, DNS server, DHCP server, Subnet. 
			Past Networks: a given machine was connected to, write time is the connection time.
			SAM hive and user information: RID, login times, last login time, password change/policy/hint.
			NTUSER hive
				recently opened files information.
			Evidence of Execution.
				User Assist (registry keys)
				ShimCache
			External Devices, USB

	#### Disk:
		- Autospy disk recovery.
			data on the disk in different unallocated clusters, which can possibly be recovered. 
			X mark indicates a deleted file.
		- Windows Prefetch files
			program information for future use.
		- Windows 10 Timeline
			a database, store recently used applications
		- Windows Jump Lists
			last executed programs and the last opened files in a system
		- setupapi.dev.log
			information related to attached devices

## Linux forensic:
	- Information
		/etc/os-release, /etc/passwd, /etc/shadow, /bin/bash, /etc/group, /etc/sudoers
		sudo last -f /var/log/wtmp, binary file read by last, data of logins.
		cat /var/log/auth.log
	- System Configuration
		/etc/hostname, /etc/timezone, /etc/network/interfaces, /etc/resolv.conf
		/etc/bash.bashrc, /etc/profile
		netstat -natp
		ps -aux
	- Persistence mechanisms: ways a program can survive after a system reboot
		Cron jobs, /etc/crontab
		Service startup, /etc/init.d
		~/.bashrc, run commands when bash shell is spawned.
	- Evidence of Execution
		cat /var/log/auth.log* 
		cat ~/.bash_history, cat ~/.zsh_history
		cat ~/.viminfo, file accessed using vim
	- Logs
		Syslog, Auth logs, Third-party logs

## Evidence Preservation

## Chain of custody
	integrity of the data.

## Order of volatility
	preserve RAM before hard drive.

## Timeline creation
	puts all the activities in chronological order.

## Tools:
	- KAPE (Kroll Artifact Parser and Extractor)
		bypass the OS locks and copy the files
	- Autopsy
		analyzes major file systems
	- Volatility
		analyzing memory dumps
		python3 vol.py -f <file> windows.info
		pslist, pstree, netstat, dlllist
		compare the memory file against YARA rules
		SSDT Hooks: system Service Descriptor Table
			An adversary can hook into this table and modify pointers to point to a location the rootkit controls.
	- Redline 
		IOC: Indicators of Compromise
			artifacts of the potential compromise
		collects various data for analysis 
			running processes, download histroy, services, files, registry structures, event logs,
	- Velociraptor

## NIST and SANS incident handling guide.
	1. Preparation 2. Identification 3. Containment 4. Eradication 5. Recovery 6. Lessons Learned

## BTK serial killer
	he sent a floppy disk, recover a deleted word document.
	
	
# Malware Analysis

### syscalls
- 32bit: https://syscalls32.paolostivanin.com/
- 64bit: https://syscalls64.paolostivanin.com/

### Paradies Clipper
- when copy and paste BTC address, the malware will change it.
- A C2 server to monitor the replacement.
- user32.dll -> f: Open/Get/Set/EmptyClipboard
