---
title: Forensic 
author: Yuchao
date: 2023-01-29 11:33:00 +0800
categories: [sec]
tags: [forensic]
math: true
mermaid: true
---

# SANS 3MinMax

Kevin Ripa  101

## 5 Windows Quick Win Artifacts

#### Registry 
- aka. hives: SAM,System,Software,Secrutiy,NTUser
- find what: MRU Lists, System searches, Browser typed URLs, USB/Wifi connection, SSIDs, Network connections, Programs/services running at startup, etc.
- https://github.com/EricZimmerman -> Registry Explorer.
- C:\Windows\system32\config\SAM
- popular: OpenSavePidIMRU, RecentDocs, SAM, USBSTOR, AppCompatCache, WordWheelQuery, ComputerName, TimeZoneInformation, CurrentVersion.
- Regeditor shows no information of SAM hive, but Registry Explorer shows the information.
- Transaction Logs: https://andreafortuna.org/2021/02/06/windows-registry-transaction-logs-in-forensic-analysis/

#### Jumplists 
- file, folder user performed historically.
- {userFile}\AppData\Roaming\Microsoft\Recent Items\AutomaticDestinations
- last folder above need to be input manually.
- "{appID}.automaticDestinations-ms" files
- jumplist explorer: "jlecmd -f {one-ms file path} "
- "jlecmd -f {one-ms file path}  --csv {output path}" output as csv.

#### ".LNK"
- {userFile}\AppData\Roaming\Microsoft\Recent Items
- files in above folder, are files interacted before.
- when date created same as date modified, mean opened once. Otherwise, more than once.
- real file has different time stamp, as file above is the shortcut`s timestamp.
- when real file deleted, link file still stays.
- ``` lecmd -f {linkFilePath} --csv {outPutPath} ``` or -d to directory.

#### Shellbags
- open a folder again, same location, same window size.
- {userFile}\AppData\Roaming\Microsoft\Windows\UsrClass.dat
- HKEY_CLASSES_ROOT\Local Settings\Software\Microsoft\Windows\Shell
- ZM tool: ShellBags Explorer. ``` SBECmd.exe -l --csv {outPutPath} ```
- eg. F: may not be the same USB device, watch meta data to check.

#### Prefetch
- C:\Windows\Prefetch
- file name eg. CONHOST.EXE-0C6456FB.pf, MSEDGEWEBVIEW2.EXE-053FE714.pf
- ZM tool: ``` pecmd -f {.pf file path} ```
- ``` pecmd -d C:\Windows\Prefetch\ --csv C:\Temp1 -q```
- WinPrefetchView, www.nirsoft.net

## Bigger data
- NAS: network attached storage.
- RAID: Redundant Array of Independent(Inexpensive) Disks.
- RAID 5: maybe the most popular one. One drive lose is acceptable. Recover takes time. Use parity.
- synology, QNAP.

## Online evidence
- https://hunch.ly/
- https://www.aircrack-ng.org/ IP not sufficient -> device

## image Surface Pro
- only 3 ports: Power Interface, USB 3, mini Display.
- use USB 3 powered hub.
- connect: USB with boot program, hard drive(get image).
- UEFI screen. Boot to Paladin OS. 
- https://sumuri.com/paladin-manual/

## log
- c:\Windows\System32\winevt\Logs
- gkape: https://ericzimmerman.github.io/KapeDocs/#!index.md
- EZ tool: Timeline Explorer.	
- Event Log Explorer. (filter)
- logon type: https://learn.microsoft.com/en-us/windows-server/identity/securing-privileged-access/reference-tools-logon-types
- Oalerts

## lies computer tolds
- LNK file: ftk imager can look at master file table(MFT), and show files, which Windows may not. (same file names, but some of them deleted)

## Volume Shadow Copy
- system->about->system protection
- ``` svvadmin list shadows /for=E: ```
- arsenal image mounter
- ShadowExplorer

## webcache
- Browser->Website Data Settings->Current Location.
- If you want to see it: 1. show hidden files. 2. (Not) Hide protected operating system files.

## Cellphone
- Do not turn off.
- Different kinds.

## password
- https://www.grc.com/haystack.htm
- cupp: wordlist builder
- Password Manager: Dashlane, Lastpass, Keypass, 1Password.

## data
- Bit: binary digit
- Byte: By eight
- nibble: 4 bits, one hex.

## Forensic resources
- Cellebrite.com/en/home; smarterforensics.com/blog/; Mac4n6.com
- Thisweekin4n6.com; Aboutdfir.com; sans.org/blog/
- blog.elcomsoft.com; Thebinaryhick.blog
- https://www.youtube.com/@MagnetForensics1/videos; binaryforay.blogspot.com

## Kape
- Kroll Artifact Parser & Extractor
- target, executable, modules.
- GUI version: gkape.

## EZViewer
- If do not know how to handle a file, it will open in hex.
- right bottom, view in hex.

## Incorrected conclusion.
- MFT entry 2 - Deleted abc.dll -> Cluster 13.
- MFT entry 3 - Exists Koala.jpg -> Cluster 13.
- Then, MFT entry 3, Koala.jpg deleted, and points to Cluster 14 like abc.xlsx.
- wrong conclusion may be: some one hide Koala.jpg as abc.dll in a system directory.
- Because Entry and storage space have no relationship between each other.

## USB
-  Vendor, Product Name, Version, and device S/N


## Tools

#### Acquisition tools
- Arsenal Image Mounter, FTK Imager, Magnet Acquire, gkape
- USB WhiteProtectOFF/ON, Forensic Copy, Magnet RAM Capture

#### Forensic Suites
- BlackLight, IEF - Internet Evidence Finder, IEF Report Viewer
- AXIOMProcess, AXIOMExamine, Paraben P2C, Autopsy

#### Artifact Tools
- autorunner, DCode Date, ExifTool GUI, GENA, Hexinator - HEX EDITOR
- Highligher, JumpList Explorer, md5summer, PhotoRec GUI
- QuickHash - FILE HASHER, ShadowExplorer, ShellBags Explorer
- Skype Log View, SRUM_DUMP, Structured Storage Viewer, thumbcache_viewer
- thumbs_viewer, Timeline Explorer, win prefetch view, WinHex

#### Browser Tools
- ESEDatabase View, chrome cookies view, FOXTRON History Examiner
- mozilla history view, mozilla cache view, hindsight GUI, chrome cache view
- Mozilla Cookies, DB Browser for SQLite, browser add ons view
- browsing history view, chrome history view, firefox downloads view
- flash cookies view, GA Cookie Cruncher, NirLauncher

#### USB Forensics
- USBDevice Forensics, USB Detective, UVCView

#### Event Log Tools
- Event Log Explorer, EVTX_VIEW

#### Email Tools
- NUIX, Kernel OST Viewer, Kernel Outlook PST Viewer

#### Registry Tools
- Registry Explorer, Registry Recon, RegistryViewer
- regripper, SAMInside, UserAssist

--- 

# Guided Hacking

## Where to Download New Malware Samples
- https://abuse.ch/
- https://bazaar.abuse.ch/
- https://www.virustotal.com/gui/home/upload
- https://www.intezer.com/
- https://malpedia.caad.fkie.fraunhofer.de/
- https://tria.ge/
- https://www.unpac.me/#/

## setup VM
- https://github.com/mandiant/flare-vm common tools on Windows.
- https://www.uwamp.com/en/ light weight PHP server, can change version.
- https://www.telerik.com/fiddler Proxy, Find C2, script(own language) reponses.
- https://github.com/mandiant/flare-fakenet-ng python script
- https://github.com/a0rtega/pafish check what to patch, to make malware do not aware in VM.
- https://github.com/d4rksystem/VBoxCloak After this ps script, pafish will find much less VM traits.
- https://hex-rays.com/ida-free/ 
- https://github.com/mandiant/flare-ida IDA plugins.
- IDA plug: ret-sync.

## syscalls
- 32bit: https://syscalls32.paolostivanin.com/
- 64bit: https://syscalls64.paolostivanin.com/

## YouHacker 
- Detect It Easy -> find library .NET
- dnspy -> . NET assembly editor
- https://pypi.org/project/pydumpck/

## Paradies Clipper
- when copy and paste BTC address, the malware will change it.
- A C2 server to monitor the replacement.
- user32.dll -> f: Open/Get/Set/EmptyClipboard

--- 

# Read Practical Malware Analysis

## types
	- Backdoor, botnet, downloader, launcher, rootkit, scareware, spam, worm
	- persistence mechanism: windows registry

## static
	1. hash as a fingerprint.
	2. find strings
	3. detect packed and obfuscated malware
	4. linked library and functions
	5. PE file headers: meta data about the file

## Dynamic:
	1. source-level, assembly-level debug.
	2. kernel, user-mode debug.


## Process VS Service:
	- A process is an instance of a particular executable (.exe program file) running. 
	- A service is a process which runs in the background and does not interact with the desktop


## PE: magic number "MZ"
	1. PE Header
		metadata information, pointers, and links to address sections in memory. 
	2. PE Data Section
		.text stores the actual code of the program
		.data holds the initialized and defined variables
		.bss holds the uninitialized data (declared variables with no assigned values)
		.rdata contains the read-only data
		.edata: contains exportable objects and related table information
		.idata imported objects and related table information
		.reloc image relocation information
		.rsrc links external resources used by the program such as images, icons, embedded binaries, and manifest file, which has all information about program versions, authors, company, and copyright!

## AV Evasion:
	1. staged payload.
	2. packer. Packing and Obfuscation.
	3. Binder.
	4. Sandbox evasion. 

## Virtual memory:
	page virtual memory to the disk to slove: more virtual memory than physical memory allocated.

## Tools:
	- PEview
	- FSG packer
	- UPX packer
	- Dependency Walker
	- Resource Hacker
		To counter: resource section contains another PE executable.
		Use:save the resource as binary data, then analyze.
			click Action>Save resource as binary file.
	- downloader
		downloads additional malware
	- Regshot
		take a baseline snapshot of the registry


## Imports: (MSDN documentation)
	- type: networking, service-manipulation, registry-manipulation.

	- WS2_32.dll		-> network functionality
	- wininet.dll		-> F: InternetOpen, InternetOpenURL	-> connects to Internet
		InternetReadFile, InternetCloseHandle, InternetOpenUrlA, InternetOpenA
	- advapi32.dll	-> permissions

	- kernel32.dll	-> F: FindFirstFile, FindNextFile	 -> filesystem(modify files)
	- kernel32.dll	-> F: CreateProcess, Sleep			 -> backdoors
	- kernel32.dll	-> F: CreateFile, WriteFile, WinExec -> write to disk & execute
	- kernel32.dll	-> F: LoadResource, FindResource	 -> loads data from resource section 

	- CreateFileA, CreateFileMappingA, and MapViewOfFile -> probably opens a file and maps it into memory.
	- LoadLibrary, or GetProcAddress -> load DLL and use its function at runtime.

## Exports: mostly for DLL
	- ServiceMain 	-> malware needs to be installed as a service.
		svchost.exe: a shared-service process that serves as a shell for loading services from DLL files.
	- rundll32: can run DLL with exports.

## Use of mutex
	only one copy of the program is running at a time.

## Dynamic analysis...

#### Before run malware:
	- run procmon
	- start Process Explorer
	- set up virtual network (including ApateDNS, Netcat, Wireshark)
#### Run malware:
	- In Process Explorer: 
		Handlers: may find Mutant.
		Dlls.
	- procmon filter process actions:
		need to filter out a certain amount of noise.
		find if it: RegSetValue, WriteFile.
			write file to copy itself.
			modify register to run on system startup.
#### Check ApateDNS
		if malware performed DNS requests.
#### Check netcat
		find what the malware requested.

## IDA Pro DLL
	- Start from DllMain
		all code that executes from the DllEntryPoint until DllMain has likely been generated by the compiler
	- CTRL-X with the cursor on gethostbyname: check cross-references.
	- byte_ prefix: IDA believes a one byte variable.
	- off_ prefix: a pointer variable.
	- Rabit hole: IDA may fail to label function like printf, and you may lost in it.

---

# 13Cubed

- https://www.youtube.com/@13Cubed/featured

---

# THM

## room keywords
- forensic, DFIR, AV, malware, reverse engineering, siem.

## Eric Zimmerman

## DFIR: An Introduction, room

#### artifacts:
	- pieces of information that provide evidence of human activity.
	- collected from the Endpoint or Server's file system, memory, or network activity.

	#### type:
		- Strings ("exec": a backdoor)
		- API calls
		- Memory dumps
		- Filesystem modifications
		- Log events
		- Running processes
		- Web requests
		- IP address string routable to Command and control server
		- IOCs can be MD5, SHA1, SHA256 hashes, IP address, C2 domain, file size, filename, file path, a registry key, etc.

	#### Windows Registry
		- if only access to disk image.
			C:\Windows\System32\Config
			NTUSER.DAT, USRCLASS.DAT
			C:\Windows\AppCompat\Programs\Amcache.hve
				save information on programs that were recently run on the system
		- transaction logs
			journal of the changelog of the registry hive.
		- Registry backups
		- tools: Registry Viewer, similar to Windows Registry Editor, but on disk image.
		- Forensic use:
			Find OS version: SOFTWARE\Microsoft\Windows NT\CurrentVersion
			Computer Name, Time Zone Information, Autostart Programs.
			Network Interfaces: IP, DNS server, DHCP server, Subnet. 
			Past Networks: a given machine was connected to, write time is the connection time.
			SAM hive and user information: RID, login times, last login time, password change/policy/hint.
			NTUSER hive
				recently opened files information.
			Evidence of Execution.
				User Assist (registry keys)
				ShimCache
			External Devices, USB

	#### Disk:
		- Autospy disk recovery.
			data on the disk in different unallocated clusters, which can possibly be recovered. 
			X mark indicates a deleted file.
		- Windows Prefetch files
			program information for future use.
		- Windows 10 Timeline
			a database, store recently used applications
		- Windows Jump Lists
			last executed programs and the last opened files in a system
		- setupapi.dev.log
			information related to attached devices

#### Linux forensic:
	- Information
		/etc/os-release, /etc/passwd, /etc/shadow, /bin/bash, /etc/group, /etc/sudoers
		sudo last -f /var/log/wtmp, binary file read by last, data of logins.
		cat /var/log/auth.log
	- System Configuration
		/etc/hostname, /etc/timezone, /etc/network/interfaces, /etc/resolv.conf
		/etc/bash.bashrc, /etc/profile
		netstat -natp
		ps -aux
	- Persistence mechanisms: ways a program can survive after a system reboot
		Cron jobs, /etc/crontab
		Service startup, /etc/init.d
		~/.bashrc, run commands when bash shell is spawned.
	- Evidence of Execution
		cat /var/log/auth.log* 
		cat ~/.bash_history, cat ~/.zsh_history
		cat ~/.viminfo, file accessed using vim
	- Logs
		Syslog, Auth logs, Third-party logs

#### Evidence Preservation

#### Chain of custody
	integrity of the data.

#### Order of volatility
	preserve RAM before hard drive.

#### Timeline creation
	puts all the activities in chronological order.

#### Tools:
	- KAPE (Kroll Artifact Parser and Extractor)
		bypass the OS locks and copy the files
	- Autopsy
		analyzes major file systems
	- Volatility
		analyzing memory dumps
		python3 vol.py -f <file> windows.info
		pslist, pstree, netstat, dlllist
		compare the memory file against YARA rules
		SSDT Hooks: system Service Descriptor Table
			An adversary can hook into this table and modify pointers to point to a location the rootkit controls.
	- Redline 
		IOC: Indicators of Compromise
			artifacts of the potential compromise
		collects various data for analysis 
			running processes, download histroy, services, files, registry structures, event logs,
	- Velociraptor

#### NIST and SANS incident handling guide.
	1. Preparation 2. Identification 3. Containment 4. Eradication 5. Recovery 6. Lessons Learned

#### BTK serial killer
	he sent a floppy disk, recover a deleted word document.
	

## KAPE, room
- Bin: execute when exe not on system. mostly EZ tools.
- Process VSCs: process Volume Shadow Copies.
- When both Target and Module Options. Module Source is not required.  Target destination is the Module source.
- "_kape.cli":  batch mode commands in the same directory of Kape.
- What search query was run on the system? -> registry: WordWheelQuery.
- module out -> Automatic Destinations -> FileFolderAccess.

## Autopsy, room
More than the room:
- Global Hash Lookup Settings
- Global File Extension Mismatch Identification Settings
- Global Keyword Search Settings
- Global Interesting Items Settings
- Yara Analyser

Full excercise: https://cfreds.nist.gov/ , to download the disk image

## Disk Analysis & Autopsy, room

---

# Certs

## GIAC Reverse Engineering Malware (GREM)
- Analyzing Malicious Office Macros
- Analyzing Malicious PDFs
- Analyzing Malicious RTF Files
- Analyzing Obfuscated Malware
- Behavioral Analysis Fundamentals
- Common Malware Patterns
- Core Reverse Engineering Concepts
- Identifying and Bypassing Anti-Analysis Techniques
- Malware Analysis Fundamentals
- Malware Flow Control and Structures
- Overcoming Misdirection Techniques
- Reversing Functions in Assembly
- Static Analysis Fundamentals
- Unpacking and Debugging Packed Malware

## GIAC Certified Incident Handler (GCIH)
- Detecting Covert Communications
- Detecting Evasive Techniques
- Detecting Exploitation Tools
- Drive-By Attacks
- Endpoint Attack and Pivoting
- Incident Response and Cyber Investigation
- Memory and Malware Investigation
- Network Investigations
- Networked Environment Attack
- Password Attacks
- Post-Exploitation Attacks
- Reconnaissance and Open-Source Intelligence
- Scanning and Mapping
- SMB Scanning
- Web App Attacks

## GIAC Certified Intrusion Analyst (GCIA)
- Advanced IDS Concepts
- Application Protocols
- Concepts of TCP/IP and the Link Layer
- Fragmentation
- IDS Fundamentals and Network Architecture
- Intrusion Detection System Rules
- IP Headers
- IPv6
- Network Forensics and Traffic Analysis
- Packet Engineering
- SiLK and Other Traffic Analysis Tools
- TCP
- Tcpdump Filters
- UDP and ICMP
- Wireshark Fundamentals

## GIAC Battlefield Forensics and Acquisition (GBFA)
- Acquiring RAM and OS Artifacts
- Acquisition Preparation
- Data on Drives
- Data on the Network
- Dead Box Acquisition
- Host Based Live Acquisition
- Manual Triage
- Manually Finding Data
- Mobile Device Acquisition/Triage
- Physical Storage Devices
- Remote Acquisition
- Storage Technologies
- Working With Evidence Files

## GIAC Certified Forensic Analyst (GCFA)
- Analyzing Volatile Malicious Event Artifacts
- Analyzing Volatile Windows Event Artifacts
- Enterprise Environment Incident Response
- File System Timeline Artifact Analysis
- Identification of Malicious System and User Activity
- Identification of Normal System and User Activity
- Introduction to File System Timeline Forensics
- Introduction to Memory Forensics
- NTFS Artifact Analysis
- Windows Artifact Analysis
